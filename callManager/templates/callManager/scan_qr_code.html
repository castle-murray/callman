{% extends 'callManager/base.html' %}
{% block title %}Scan QR Code - {{ event.event_name }}{% endblock %}
{% block content %}
    <div class="max-w-2xl mx-auto p-6 bg-card-bg rounded-lg shadow-md dark:bg-dark-card-bg dark:shadow-dark-shadow">
        <h1 class="text-2xl font-bold mb-4 text-text-heading dark:text-dark-text-primary">Scan QR Code for {{ event.event_name }}</h1>
        <p class="text-text-primary mb-4 dark:text-dark-text-primary">Use the iPad camera to scan a worker's QR code.</p>
        <div id="qr-reader" class="mb-4"></div>
        <div id="error-message" class="text-text-red mb-4 dark:text-dark-text-red hidden"></div>
        <a href="{% url 'event_detail' event.slug %}" class="inline-block text-primary hover:underline dark:text-dark-text-blue dark:hover:text-dark-primary-hover">Back to Event</a>
    </div>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script>
        function onScanSuccess(decodedText, decodedResult) {
            try {
                const tokenMatch = decodedText.match(/\/clock-in\/([0-9a-f-]{36})\//);
                if (tokenMatch && tokenMatch[1]) {
                    window.location.href = `/clock-in/${tokenMatch[1]}/`;
                } else {
                    document.getElementById('error-message').textContent = 'Invalid QR code format.';
                    document.getElementById('error-message').classList.remove('hidden');
                }
            } catch (e) {
                document.getElementById('error-message').textContent = 'Error processing QR code.';
                document.getElementById('error-message').classList.remove('hidden');
            }
        }
        function onScanFailure(error) {
            console.warn(`QR scan error: ${error}`);
        }
        const html5QrCode = new Html5Qrcode("qr-reader");
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        html5QrCode.start(
            { facingMode: "environment" },
            config,
            onScanSuccess,
            onScanFailure
        ).catch(err => {
            document.getElementById('error-message').textContent = 'Failed to access camera: ' + err;
            document.getElementById('error-message').classList.remove('hidden');
        });
    </script>
{% endblock %}
