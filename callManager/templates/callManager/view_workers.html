{% extends 'callManager/base.html' %}
{% load callman_tags %}
{% block title %}View Workers - CallMan{% endblock %}
{% block content %}
    <div class="flex justify-betwewn mx-auto">
        <div class="flex-grow">
            <h1 class="text-2xl font-bold mb-6 text-text-heading dark:text-dark-text-primary">Workers</h1>
        </div>
        <div class="relative">
            <button id="actions-dropdown-toggle" class="bg-primary text-dark-text-primary p-2 rounded hover:bg-primary-hover dark:bg-dark-primary dark:hover:bg-dark-primary-hover flex items-center">
                Actions
                <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>
            <div id="actions-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-card-bg dark:bg-dark-card-bg rounded-lg shadow-lg border border-gray-200 dark:border-dark-border z-10">
                <a href="{% url 'import_workers' %}" class="block px-4 py-2 text-text-tertiary dark:text-dark-text-tertiary hover:bg-gray-100 dark:hover:bg-dark-border-dark rounded-t-lg {% if not has_workers %}ring-2 ring-red-500{% endif %}">Import Phone Contacts</a>
                <a href="{% url 'worker_self_add_qr' company.slug %}" class="block px-4 py-2 text-text-tertiary dark:text-dark-text-tertiary hover:bg-gray-100 dark:hover:bg-dark-border-dark">Worker Self Add QR</a>
                <div class="relative">
                    <button hx-get="{% url 'clear_unused_contacts' %}" hx-target="body" hx-swap="outerHTML" hx-trigger="click" hx-confirm="Are you sure you want to delete all unused contacts? This cannot be undone." data-tooltip="Deletes workers who have never been assigned to any jobs. Workers with job history will not be affected." class="block w-full text-left px-4 py-2 text-danger dark:text-dark-danger hover:bg-gray-100 dark:hover:bg-dark-border-dark rounded-b-lg">Clear Unused Contacts</button>
                    <div class="tooltip hidden absolute z-50 bg-gray-800 text-white text-sm rounded px-2 py-1 pointer-events-none">
                        <div class="tooltip-text"></div>
                    </div>
                </div>
            </div>
        </div>
    </div> 
    <div class="bg-card-bg p-6 rounded-lg shadow-md max-w-4xl mx-auto dark:bg-dark-card-bg dark:shadow-dark-shadow">
        <form method="get" class="mb-4 flex flex-wrap gap-4">
            <input type="text" 
                   autofocus
                   name="search" 
                   value="{{ search_query }}" 
                   placeholder="Search by name or phone..." 
                   class="w-full max-w-md p-2 border rounded bg-card-bg text-text-tertiary focus:outline-none focus:ring-2 focus:ring-primary dark:bg-dark-card-bg dark:text-dark-text-tertiary dark:border-dark-border dark:focus:ring-dark-primary"
                   hx-get="{% url 'search_workers' %}"
                   hx-target="#workers-list"
                   hx-trigger="input delay:100ms"
                   hx-include="[name='search'], [name='skill'], [name='per_page']">
            <select id="skill" name="skill" class="w-full max-w-xs p-2 border rounded bg-card-bg text-text-tertiary focus:outline-none focus:ring-2 focus:ring-primary dark:bg-dark-card-bg dark:text-dark-text-tertiary dark:border-dark-border dark:focus:ring-dark-primary"
                    hx-get="{% url 'search_workers' %}"
                    hx-target="#workers-list"
                    hx-trigger="change"
                    hx-include="[name='search'], [name='skill'], [name='per_page']">
                <option value="">All Skills</option>
                {% for labor_type in labor_types %}
                    <option value="{{ labor_type.id }}" {% if skill_id == labor_type.id|stringformat:"i" %}selected{% endif %}>{{ labor_type.name }}</option>
                {% endfor %}
            </select>
            <select id="per_page" name="per_page" class="w-full max-w-[120px] p-2 border rounded bg-card-bg text-text-tertiary focus:outline-none focus:ring-2 focus:ring-primary dark:bg-dark-card-bg dark:text-dark-text-tertiary dark:border-dark-border dark:focus:ring-dark-primary"
                    hx-get="{% url 'search_workers' %}"
                    hx-target="#workers-list"
                    hx-trigger="change"
                    hx-include="[name='search'], [name='skill'], [name='per_page']">
                <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
                <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
            </select>
            <a href="{% url 'view_workers' %}" class="bg-secondary text-dark-text-primary p-2 rounded hover:bg-secondary-hover dark:bg-dark-secondary dark:hover:bg-dark-secondary-hover">Reset</a>
        </form>
        <div id="workers-list">
            {% include 'callManager/workers_list_partial.html' %}
        </div>
        <h2 class="text-xl font-semibold mt-6 mb-2 text-text-heading dark:text-dark-text-primary">Add New Worker</h2>
        <form method="post" class="flex flex-col text-text-tertiary dark:text-dark-text-tertiary">
            {% csrf_token %}
            <input type="hidden" name="add_worker" value="true">
            <div class="flex items-center mb-2">
                {{ add_form.name.label_tag }}
                {{ add_form.name }}
            </div>
            <div class="flex items-center mb-2">
                {{ add_form.phone_number.label_tag }}
                {{ add_form.phone_number }}
            </div>
            <div class="mb-2">
                {{ add_form.labor_types.label_tag }}
                {{ add_form.labor_types }}
            </div>
            <button type="submit" class="bg-success text-dark-text-primary px-2 py-1 rounded hover:bg-success-hover dark:bg-dark-success dark:hover:bg-dark-success-hover">Add</button>
        </form>
    </div>
{% endblock %}
