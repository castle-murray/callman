{% extends 'callManager/base.html' %}
{% load callman_tags %}
{% block title %}{{ event.event_name }} - CallMan{% endblock %}
{% block content %}
<h1 class="text-3xl ml-5 font-bold mb-6 text-text-heading dark:text-dark-text-primary">{{ event.event_name }}</h1>
{% if messages %}
<div class="mt-4">
    {% for message in messages %}
    <p class="{% if message.tags == 'success' %}text-text-green dark:text-dark-text-green{% elif message.tags == 'warning' %}text-text-yellow dark:text-dark-text-yellow{% else %}text-text-red dark:text-dark-text-red{% endif %}">{{ message }}</p>
    {% endfor %}
</div>
{% endif %}
<div class="mb-6 ml-5 flex space-x-4">
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="send_messages" value="true">
        <button type="submit" class="bg-success text-dark-text-primary p-4 rounded hover:bg-success-hover dark:bg-dark-success dark:hover:bg-dark-success-hover">Send Messages</button>
    </form>
    <form method="post" action="{% url 'send_clock_in_link' event.slug %}">
        {% csrf_token %}
        <button type="submit" class="bg-success text-dark-text-primary p-4 rounded hover:bg-success-hover dark:bg-dark-success dark:hover:bg-dark-success-hover">Send QR Code</button>
    </form>
    <a href="{% url 'scan_qr_code' event.slug %}" class="bg-success text-dark-text-primary p-4 rounded hover:bg-success-hover dark:bg-dark-success dark:hover:bg-dark-success-hover">Scan QR Code</a>
</div>
{% if message %}
<p class="text-text-green mb-4 dark:text-dark-text-green">{{ message }}</p>
{% endif %}
<div class="bg-card-bg p-6 rounded-lg shadow mb-6 dark:bg-dark-card-bg dark:shadow-dark-shadow">
    <p class="text-text-tertiary dark:text-dark-text-tertiary"><strong>Date:</strong> 
    {% if event.is_single_day %}
    {{ event.start_date }}
    {% else %}
    {{ event.start_date }} - {{ event.end_date }}
    {% endif %}
    </p>
    <p class="text-text-tertiary dark:text-dark-text-tertiary"><strong>Location:</strong> {{ event.event_location }}</p>
    <p class="text-text-tertiary dark:text-dark-text-tertiary">{{ event.event_description|default:"No description provided" }}</p>
</div>
<div class="bg-card-bg p-2 w-full rounded-lg shadow mb-6 dark:bg-dark-card-bg dark:shadow-dark-shadow">
    <h2 class="text-xl font-semibold mb-4 text-text-heading dark:text-dark-text-primary">Call Times</h2>
    {% if call_times %}
    {% for call_time in call_times %}
    <div class="mb-4">
        <h3 class="text-lg font-semibold text-text-heading dark:text-dark-text-primary">
            <a href="{% url 'call_time_request_list' call_time.slug %}" class="text-primary hover:underline dark:text-dark-text-blue dark:hover:text-dark-primary-hover">
                {{ call_time.name }} at {{ call_time.time }} on {{ call_time.date }}
            </a>
            <a href="{% url 'call_time_tracking' call_time.slug %}" class="ml-2 inline-block bg-indigo text-dark-text-primary px-2 py-1 rounded hover:bg-indigo-hover dark:bg-dark-indigo dark:hover:bg-dark-indigo-hover">Time Sheet</a>
            <a href="{% url 'edit_call_time' call_time.slug %}" class="ml-2 inline-block bg-primary text-dark-text-primary px-2 py-1 rounded hover:bg-primary-hover dark:bg-dark-primary dark:hover:bg-dark-primary-hover">Edit Call Time</a>
            <form method="post" action="{% url 'delete_call_time' call_time.slug %}" class="inline ml-2">
                {% csrf_token %}
                <button type="submit" class="bg-danger text-dark-text-primary px-2 py-1 rounded hover:bg-danger-hover dark:bg-dark-danger dark:hover:bg-dark-danger-hover" 
                    onclick="return confirm('Are you sure you want to delete this call time? This will also delete associated labor requirements.');">
                    Delete
                </button>
            </form>
        </h3>
        <ul class="space-y-2">
            {% for labor in call_time.labor_requirements.all %}
            {% with counts=labor_counts|get_item:labor.id %}
            <li class="flex justify-between items-center text-text-tertiary dark:text-dark-text-tertiary">
                <span>
                    â€¢ {{ labor.labor_type.name }} - 
                    <a href="{% url 'labor_request_list' labor.slug %}" class="text-primary hover:underline dark:text-dark-text-blue dark:hover:text-dark-primary-hover">
                        {{ counts.display_text }}
                    </a>
                </span>
                <div class="space-x-2">
                    <a href="{% url 'edit_labor_requirement' labor.slug %}" 
                        class="inline-block bg-primary text-dark-text-primary px-2 py-1 rounded hover:bg-primary-hover dark:bg-dark-primary dark:hover:bg-dark-primary-hover">
                        Edit
                    </a>
                    <form method="post" action="{% url 'delete_labor_requirement' labor.slug %}" class="inline">
                        {% csrf_token %}
                        <button type="submit" class="bg-danger text-dark-text-primary px-2 py-1 rounded hover:bg-danger-hover dark:bg-dark-danger dark:hover:bg-dark-danger-hover" 
                            onclick="return confirm('Are you sure you want to delete this labor requirement?');">
                            Delete
                        </button>
                    </form>
                </div>
            </li>
            {% endwith %}
            {% endfor %}
        </ul>
        <a href="{% url 'add_labor_to_call' call_time.slug %}" class="inline-block bg-primary text-dark-text-primary px-2 py-1 rounded hover:bg-primary-hover dark:bg-dark-primary dark:hover:bg-dark-primary-hover">Add Labor</a>
    </div>
    {% endfor %}
    {% else %}
    <p class="text-text-secondary dark:text-dark-text-secondary">No call times defined yet.</p>
    {% endif %}
    <a href="{% url 'add_call_time' event.slug %}" class="mt-4 inline-block bg-primary text-dark-text-primary p-2 rounded hover:bg-primary-hover dark:bg-dark-primary dark:hover:bg-dark-primary-hover">Add Call Time</a>
</div>
<div id="worker-modal" class="mt-4">
    {% if request.path == '/labor/'|add:labor.slug|add:'/fill/' %}
    {% include 'callManager/fill_labor_call.html' %}
    {% endif %}
</div>
{% endblock %}
