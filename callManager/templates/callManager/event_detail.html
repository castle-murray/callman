{% extends 'callManager/base.html' %}
{% load callman_tags %}
{% block title %}{{ event.event_name }} - CallMan{% endblock %}
{% block content %}
<h1 class="text-3xl ml-5 font-bold mb-6 text-text-heading dark:text-dark-text-primary">{{ event.event_name }}</h1>
<div class="mb-6 ml-5 flex space-x-4">
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="send_messages" value="true">
        <button type="submit" class="shadow-sm shadow-secondary dark:shadow-dark-secondary bg-success text-dark-text-primary p-4 rounded hover:bg-success-hover dark:bg-dark-success dark:hover:bg-dark-success-hover">Send Messages</button>
    </form>
    {% if company.time_tracking %}
    <form method="post" action="{% url 'send_clock_in_link' event.slug %}">
        {% csrf_token %}
        <button type="submit" class="shadow-sm shadow-secondary dark:shadow-dark-secondary bg-success text-dark-text-primary p-4 rounded hover:bg-success-hover dark:bg-dark-success dark:hover:bg-dark-success-hover">Send QR to all</button>
    </form>
    <a href="{% url 'scan_qr_code' event.slug %}" class="shadow-sm shadow-secondary dark:shadow-dark-secondary bg-success text-dark-text-primary p-4 rounded hover:bg-success-hover dark:bg-dark-success dark:hover:bg-dark-success-hover">Scan QR Code</a>
    <a href="{% url 'generate_signin_qr' event.slug %}" class="shadow-sm shadow-secondary dark:shadow-dark-secondary bg-success text-dark-text-primary p-4 rounded hover:bg-success-hover dark:bg-dark-success dark:hover:bg-dark-success-hover">Sign In Station</a>
    {% endif %}
</div>
<div class="bg-card-bg p-6 rounded-lg shadow mb-6 dark:bg-dark-card-bg dark:shadow-dark-shadow">
    <p class="text-text-tertiary dark:text-dark-text-tertiary"><strong>Date:</strong> 
    {% if event.is_single_day %}
    {{ event.start_date }}
    {% else %}
    {{ event.start_date }} - {{ event.end_date }}
    {% endif %}
    </p>
    <p class="text-text-tertiary dark:text-dark-text-tertiary"><strong>Location:</strong> {{ event.location_profile.name|default:"Not specified" }}</p>
    <p class="text-text-tertiary dark:text-dark-text-tertiary">{{ event.event_description|default:"No description provided" }}</p>
</div>
<div class="divide-y divide-primary ark:divide-dark-primary bg-card-bg p-2 w-full rounded-lg shadow mb-6 dark:bg-dark-card-bg dark:shadow-dark-shadow">
    <h2 class="text-xl font-semibold mb-4 text-text-heading dark:text-dark-text-primary">Call Times</h2>
    {% if call_times %}
    {% for call_time in call_times %}
    <div class="mb-4">
        <h3 class="text-lg font-semibold text-text-heading dark:text-dark-text-primary">
            <a href="{% url 'call_time_request_list' call_time.slug %}" class="text-primary hover:underline dark:text-dark-text-blue dark:hover:text-dark-primary-hover">
                {{ call_time.name }} at {{ call_time.time }} on {{ call_time.date }}
            </a>
            <div class="relative inline-block">
                <button id="actions-toggle-{{ call_time.slug }}" class="ml-2 mt-1 shadow-sm shadow-secondary dark:shadow-dark-secondary bg-primary text-dark-text-primary px-2 py-1 rounded hover:bg-primary-hover dark:bg-dark-primary dark:hover:bg-dark-primary-hover flex items-center">
                    Actions
                    <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
                <div id="actions-dropdown-{{ call_time.slug }}" class="hidden absolute right-0 mt-2 w-48 bg-card-bg dark:bg-dark-card-bg rounded-lg shadow-sm border border-gray-200 dark:border-dark-border z-10">
                    {% if company.time_tracking %}
                    <a href="{% url 'call_time_tracking' call_time.slug %}" class="block px-4 py-2 text-text-tertiary dark:text-dark-text-tertiary hover:bg-gray-100 dark:hover:bg-dark-border-dark rounded-t-lg">Time Sheet</a>
                    {% endif %}
                    <a href="{% url 'edit_call_time' call_time.slug %}" class="block px-4 py-2 text-text-tertiary dark:text-dark-text-tertiary hover:bg-gray-100 dark:hover:bg-dark-border-dark">Edit Call Time</a>
                    <a href="{% url 'copy_call_time' call_time.slug %}" class="block px-4 py-2 text-text-tertiary dark:text-dark-text-tertiary hover:bg-gray-100 dark:hover:bg-dark-border-dark">Copy Call Time</a>
                    {% if call_time.has_changed %}
                    <a href="{% url 'call_time_confirmations' call_time.slug %}" class="block px-4 py-2 text-text-tertiary dark:text-dark-text-tertiary hover:bg-gray-100 dark:hover:bg-dark-border-dark">Confirmations</a>
                    {% endif %}
                    {% if user.manager %}
                    <button onclick="if(confirm('Are you sure you want to delete this call time? This will also delete associated jobs.')) { document.getElementById('delete-form-{{ call_time.slug }}').submit(); }" class="block w-full text-left px-4 py-2 text-danger dark:text-dark-danger hover:bg-gray-100 dark:hover:bg-dark-border-dark rounded-b-lg">Delete</button>
                    {% endif %}
                </div>
                <form id="delete-form-{{ call_time.slug }}" method="post" action="{% url 'delete_call_time' call_time.slug %}" class="hidden">
                    {% csrf_token %}
                </form>
            </div>
        </h3>
        <ul class="mt-2 divide-y divide-success dark:divide-dark-secondary mb-2">
            {% for labor in call_time.labor_requirements.all %}
            {% with counts=labor_counts|get_item:labor.id %}
            <li class="p-1 flex rounded-md box-shadow shadow-md shadow-neutral-400 dark:shadow-neutral-800 justify-between bg-body-bg dark:bg-slate-950 items-center">
                <span class="ml-2">
                    â€¢ <a href="{% url 'labor_request_list' labor.slug %}" class="text-secondary hover:underline dark:dark-text-secondary dark:hover:text-dark-primary-hover">
                        {{ labor.labor_type.name }} - {{ counts.display_text|safe }}
                        
                    <div class="tooltip hidden absolute z-10 bg-gray-800 text-white text-sm p-2 rounded shadow-md">
                        <div class="tooltip-text"></div>
                    </div>
                    </a>
                </span>
                <div class="space-x-2">
                        {% if user.manager %}
                    <a href="{% url 'edit_labor_requirement' labor.slug %}" 
                        class="inline-block bg-primary text-dark-text-primary px-2 shadow-sm shadow-secondary rounded hover:bg-primary-hover dark:bg-dark-primary dark:hover:bg-dark-primary-hover">
                        Edit
                    </a>
                    <form method="post" action="{% url 'delete_labor_requirement' labor.slug %}" class="inline">
                        {% csrf_token %}
                        <button type="submit" class="bg-danger text-dark-text-primary px-2 shadow-sm shadow-secondary rounded hover:bg-danger-hover dark:bg-dark-danger dark:hover:bg-dark-danger-hover" 
                            onclick="return confirm('Are you sure you want to delete this labor requirement?');">
                            Delete
                        </button>
                        {% endif %}
                    </form>
                </div>
            </li>
            {% endwith %}
            {% endfor %}
        </ul>
        <a href="{% url 'add_labor_to_call' call_time.slug %}" class="inline-block bg-primary text-dark-text-primary px-2 py-1 rounded hover:bg-primary-hover dark:bg-dark-primary dark:hover:bg-dark-primary-hover">Add Labor</a>
    </div>
    {% endfor %}
    {% else %}
    <p class="text-text-secondary dark:text-dark-text-secondary">No call times defined yet.</p>
    {% endif %}
    <a href="{% url 'add_call_time' event.slug %}" class="mt-4 inline-block bg-primary text-dark-text-primary p-2 rounded hover:bg-primary-hover dark:bg-dark-primary dark:hover:bg-dark-primary-hover">Add Call Time</a>
</div>
<div id="worker-modal" class="mt-4">
    {% if request.path == '/labor/'|add:labor.slug|add:'/fill/' %}
    {% include 'callManager/fill_labor_call.html' %}
    {% endif %}
</div>
<div class"hidden bg-yellow bg-dark-yellow bg-bg-available bg-dark-bg-available text-text-tertiary text-green text-dark-text-green"></div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentDropdown = null;
    let currentIndex = -1;
    let menuItems = [];

    // Handle all call time action dropdowns
    document.querySelectorAll('[id^="actions-toggle-"]').forEach(toggle => {
        const slug = toggle.id.replace('actions-toggle-', '');
        const dropdown = document.getElementById(`actions-dropdown-${slug}`);
        
        if (dropdown) {
            toggle.addEventListener('click', (e) => {
                e.stopPropagation();
                
                // Close all other dropdowns
                document.querySelectorAll('[id^="actions-dropdown-"]').forEach(otherDropdown => {
                    if (otherDropdown !== dropdown) {
                        otherDropdown.classList.add('hidden');
                    }
                });
                
                dropdown.classList.toggle('hidden');
                
                // Set up keyboard navigation for this dropdown
                if (!dropdown.classList.contains('hidden')) {
                    currentDropdown = dropdown;
                    menuItems = dropdown.querySelectorAll('a, button');
                    currentIndex = -1;
                    menuItems.forEach(item => item.classList.remove('bg-gray-100', 'dark:bg-dark-border-dark'));
                } else {
                    currentDropdown = null;
                    currentIndex = -1;
                }
            });
        }
    });
    
    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
        if (currentDropdown && !currentDropdown.classList.contains('hidden')) {
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                currentIndex = (currentIndex + 1) % menuItems.length;
                updateHighlight();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                currentIndex = currentIndex <= 0 ? menuItems.length - 1 : currentIndex - 1;
                updateHighlight();
            } else if (e.key === 'Enter' && currentIndex >= 0) {
                e.preventDefault();
                menuItems[currentIndex].click();
            } else if (e.key === 'Escape') {
                currentDropdown.classList.add('hidden');
                currentDropdown = null;
                currentIndex = -1;
            }
        }
    });
    
    function updateHighlight() {
        menuItems.forEach((item, index) => {
            if (index === currentIndex) {
                item.classList.add('bg-gray-100', 'dark:bg-dark-border-dark');
            } else {
                item.classList.remove('bg-gray-100', 'dark:bg-dark-border-dark');
            }
        });
    }
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('[id^="actions-dropdown"]') && !e.target.closest('[id^="actions-toggle"]')) {
            document.querySelectorAll('[id^="actions-dropdown-"]').forEach(dropdown => {
                dropdown.classList.add('hidden');
            });
            currentDropdown = null;
            currentIndex = -1;
        }
    });
});
</script>
{% endblock %}
