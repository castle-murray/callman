{% extends 'callManager/base.html' %}
{% load callman_tags %}

{% block title %}{{ event.event_name }} - CallMan{% endblock %}

{% block content %}
<h1 class="text-3xl ml-5 font-bold mb-6">{{ event.event_name }}</h1>
{% if messages %}
<div class="mt-4">
    {% for message in messages %}
    <p class="{% if message.tags == 'success' %}text-green-600{% elif message.tags == 'warning' %}text-yellow-600{% else %}text-red-600{% endif %}">{{ message }}</p>
    {% endfor %}
</div>
{% endif %} 
<form method="post" class="mb-6 ml-5">
    {% csrf_token %}
    <input type="hidden" name="send_messages" value="true">
    <button type="submit" class="bg-green-500 text-white p-4 rounded hover:bg-green-600">Send Messages</button>
</form>
{% if message %}
<p class="text-green-600 mb-4">{{ message }}</p>
{% endif %}

<div class="bg-white p-6 rounded-lg shadow mb-6">
    <p><strong>Date:</strong> 
    {% if event.is_single_day %}
    {{ event.start_date }}
    {% else %}
    {{ event.start_date }} - {{ event.end_date }}
    {% endif %}
    </p>
    <p><strong>Location:</strong> {{ event.event_location }}</p>
    <p><strong>Description:</strong> {{ event.event_description|default:"No description provided" }}</p>
    <p><strong>Created By:</strong> {{ event.created_by.user.get_full_name|default:"Unknown" }}</p>
</div>

<div class="bg-white p-2 w-full rounded-lg shadow mb-6">
    <h2 class="text-xl font-semibold mb-4">Call Times</h2>
    {% if call_times %}
    {% for call_time in call_times %}
    <div class="mb-4">
        <h3 class="text-lg font-semibold">
            <a href="{% url 'call_time_request_list' call_time.slug %}" class="text-blue-500 hover:underline">
                {{ call_time.name }} at {{ call_time.time }} on {{ call_time.date }}
            </a>
            <a href="{% url 'edit_call_time' call_time.slug %}" class="ml-2 inline-block bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600">Edit Call Time</a>
            <form method="post" action="{% url 'delete_call_time' call_time.slug %}" class="inline ml-2">
                {% csrf_token %}
                <button type="submit" class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600" 
                    onclick="return confirm('Are you sure you want to delete this call time? This will also delete associated labor requirements.');">
                    Delete
                </button>
            </form>
        </h3>
        <ul class="space-y-2">
            {% for labor in call_time.labor_requirements.all %}
            {% with counts=labor_counts|get_item:labor.id %}
            <li class="flex justify-between items-center">
                <span>
                    â€¢ {{ labor.labor_type.name }} - 
                    <a href="{% url 'labor_request_list' labor.slug %}" class="text-blue-500 hover:underline">
                        {{ counts.display_text }}
                    </a>
                </span>
                <div class="space-x-2">
                    <a href="{% url 'edit_labor_requirement' labor.slug %}" 
                        class="inline-block bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600">
                        Edit
                    </a>
                    <form method="post" action="{% url 'delete_labor_requirement' labor.slug %}" class="inline">
                        {% csrf_token %}
                        <button type="submit" class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600" 
                            onclick="return confirm('Are you sure you want to delete this labor requirement?');">
                            Delete
                        </button>
                    </form>
                </div>
            </li>
            {% endwith %}
            {% endfor %}
        </ul>
        <a href="{% url 'add_labor_to_call' call_time.slug %}" class="inline-block bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600">Add Labor</a>
    </div>
    {% endfor %}
    {% else %}
    <p class="text-gray-600">No call times defined yet.</p>
    {% endif %}
    <a href="{% url 'add_call_time' event.slug %}" class="mt-4 inline-block bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Add Call Time</a>
</div>

<div id="worker-modal" class="mt-4">
    {% if request.path == '/labor/'|add:labor.slug|add:'/fill/' %}
    {% include 'callManager/fill_labor_call.html' %}
    {% endif %}
</div>
{% endblock %}
